datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==========================================
// MODELOS DE AUTENTICAÇÃO E USUÁRIO
// ==========================================

model User {
  id            String    @id @default(uuid())
  firebaseUid   String    @unique // UID do Firebase Auth
  email         String    @unique
  name          String?
  phone         String?
  cpf           String?   @unique
  avatar        String?   // URL da foto de perfil

  // Endereço
  cep           String?
  street        String?
  number        String?
  complement    String?
  neighborhood  String?
  city          String?
  state         String?

  // Dados acadêmicos
  educationLevel String?  // ENSINO_MEDIO, GRADUACAO, POS_GRADUACAO
  currentSchool  String?

  // Status
  emailVerified Boolean   @default(false)
  isActive      Boolean   @default(true)

  // Preferências
  receiveEmails Boolean   @default(true)
  receiveSms    Boolean   @default(true)
  receiveWhatsapp Boolean @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relacionamentos
  favorites     Favorite[]
  enrollments   Enrollment[]
  searchHistory SearchHistory[]

  @@index([email])
  @@index([firebaseUid])
  @@index([cpf])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  courseId  String   // ID do curso na API externa
  courseName String
  courseSlug String
  institutionName String?
  modalidade String?
  price     Float?
  discount  Float?

  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
}

model Enrollment {
  id              String   @id @default(uuid())
  userId          String

  // Dados do curso
  courseId        String
  courseName      String
  institutionName String
  modalidade      String
  turno           String?

  // Valores
  originalPrice   Float?
  finalPrice      Float?
  discount        Float?

  // Status
  status          EnrollmentStatus @default(PENDING)
  paymentStatus   PaymentStatus    @default(PENDING)

  // Datas
  enrollmentDate  DateTime?
  startDate       DateTime?

  // Referências externas
  externalId      String?  // ID no sistema externo
  paymentId       String?  // ID do pagamento

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model SearchHistory {
  id          String   @id @default(uuid())
  userId      String

  query       String?
  course      String?
  city        String?
  state       String?
  modalidade  String?
  nivel       String?

  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum EnrollmentStatus {
  PENDING         // Aguardando matrícula
  IN_PROGRESS     // Matrícula em andamento
  ENROLLED        // Matriculado
  CANCELLED       // Cancelado
  COMPLETED       // Concluído
}

enum PaymentStatus {
  PENDING         // Aguardando pagamento
  PROCESSING      // Processando
  PAID            // Pago
  FAILED          // Falhou
  REFUNDED        // Reembolsado
  CANCELLED       // Cancelado
}

// ==========================================
// MODELO DE LEADS (CAPTURA DE INTERESSADOS)
// ==========================================

model Lead {
  id          String   @id @default(uuid())
  name        String
  cpf         String
  email       String
  phone       String
  courseNames String[] // Cursos de interesse

  // Dados do curso (se disponível)
  courseId    String?
  courseName  String?
  institutionName String?
  modalidade  String?

  // Status do lead
  status      LeadStatus @default(NEW)
  convertedAt DateTime?  // Data de conversão (quando virou enrollment)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([cpf])
  @@index([email])
  @@index([status])
}

enum LeadStatus {
  NEW           // Novo lead
  CONTACTED     // Contactado
  INTERESTED    // Interessado
  CONVERTED     // Convertido (fez matrícula)
  LOST          // Perdido
}

// ==========================================
// MODELOS EXISTENTES (CURSOS)
// ==========================================

model Curso {
  id         String @id @default(uuid())
  nome       String
  slug       String
  brand      String @default("anhanguera")
  externalId String

  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  faculdades FaculdadeCurso[]

  @@unique([slug, brand])
  @@unique([brand, externalId])
}

model Unidade {
  id          String           @id @default(uuid())
  externalId  String           @unique
  nome        String
  endereco    String
  numero      String?
  complemento String?
  bairro      String?
  cidade      String
  estado      String
  cep         String
  turno       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  faculdades  FaculdadeCurso[]
}

model FaculdadeCurso {
  id            String    @id @default(uuid())
  cursoId       String
  unidadeId     String
  modalidade    String
  turno         String
  precoOriginal Float?
  precoComBolsa Float?
  vencimento    DateTime?
  ofertaId      String?
  origem        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  curso   Curso   @relation(fields: [cursoId], references: [id])
  unidade Unidade @relation(fields: [unidadeId], references: [id])

  @@unique([cursoId, unidadeId, modalidade, turno])
}
